# Debian CD Image Build Instructions

The build of Debian CD Image released in this repository involves the
following steps.

* [Build kernel debs](#build-kernel-debs)
* [Build debian-installer kernel module udebs](#build-debian-installer-kernel-module-udebs)
* [Build debian-installer](#build-debian-installer)
* [Build CD image](#build-cd-image)

The first step can be done on x86/amd64 system with cross-compile.  The
rest should be natively done on arm64 Debian Sid system.  Docker container
would be a good choice, and the steps documented here are tested on Debian
Sid docker container.  Let's explore each of the steps in details.


## Build kernel deb

It can be native or cross-compile build.  To get a faster build, we
choose cross-compile build here.

```
$ git checkout https://github.com/aarch64-laptops/linux.git
$ cd linux/
$ git checkout -b laptops-5.11 origin/laptops-5.11
$ export CROSS_COMPILE=aarch64-none-linux-gnu-
$ make ARCH=arm64 distro_defconfig
$ make ARCH=arm64 LOCALVERSION="-custom" -j15 deb-pkg
```

After the build completes, `linux-image-5.11.0-custom_5.11.0-custom-1_arm64.deb`
should be available in the parent directory.  It will be used by the
following steps executed in Docker container.


## Build debian-installer kernel module udebs

[kernel-wedge](https://salsa.debian.org/installer-team/kernel-wedge) is used
to generate kernel module udebs for debian-installer.

* Install kernel-wedge.

```
$ sudo apt install kernel-wedge
```

* Clone debian-cdimage repository, copy kernel deb into `simple-cdd/localpackages/`,
  and install the kernel deb.  The kernel-wedge requires the installer
  kernel package be installed on the system to build kernel module udebs.

```
$ cd $HOME
$ git clone https://github.com/aarch64-laptops/debian-cdimage.git
$ scp <build_machine_path>/linux-image-5.11.0-custom_5.11.0-custom-1_arm64.deb debian-cdimage/simple-cdd/localpackages/
$ sudo dpkg -i debian-cdimage/simple-cdd/localpackages/linux-image-5.11.0-custom_5.11.0-custom-1_arm64.deb
```

* Go to `linux-kernel-di-arm64` directory, which holds a debian source package.
  It's manually created for building kernel module udebs for debian-installer.
  The `modules` folder and `package-list` file are copied from
  [debian kernel tree](https://salsa.debian.org/kernel-team/linux) with
  desired tag.  Generate `debian/control` and start the build.  After build
  completes, a bunch of .udeb files will be found in the parent folder.

```
$ cd debian-cdimage/kernel-wedge/linux-kernel-di-arm64/
$ export KW_DEFCONFIG_DIR=$PWD
$ kernel-wedge gen-control > debian/control
$ kernel-wedge build-arch arm64
```


## Build debian-installer

The steps documented here are basically collected from debian-installer
[WIKI](https://wiki.debian.org/DebianInstaller/Build) page and 
[README](https://salsa.debian.org/installer-team/debian-installer/-/tree/master/build).

* Check out debian-installer source and install build dependencies.

```
$ sudo apt install myrepos
$ cd ~/debian-cdimage/
$ git clone https://salsa.debian.org/installer-team/d-i.git debian-installer
$ cd debian-installer
$ scripts/git-setup
$ mr checkout
$ sudo apt build-dep debian-installer
```

* The grub-installer package from `sid main/debian-installer` repository
  doesn't work for AArch64 laptops, because EFI variables runtime service
  is not available on the devices. We need to apply a patch and regenerate
  the package for CD image build.

```
$ cd packages/grub-installer/
$ git am ../../../patches/debian-installer/grub-installer/0001-grub-installer-no-nvram-for-arm64.patch
$ sudo apt build-dep grub-installer
$ dpkg-buildpackage -b
$ cd ../
$ cp grub-installer_1.176_arm64.udeb ../../simple-cdd/localpackages/
```

* Prepare localudebs for debian-installer build.  The kernel module udebs
  generated by kernel-wedge are copied here in this step.

```
$ cd ../installer/build/
$ cp ../../../kernel-wedge/*.udeb localudebs/
$ echo "deb http://deb.debian.org/debian sid main/debian-installer" >> sources.list.udeb.local
$ echo "deb [trusted=yes] copy:$PWD localudebs/" >> sources.list.udeb.local
```

* Modify config/arm64.cfg to customize local version string for
  differentiating from official Debian image, and disable Secure Boot build.

```
$ sed -i "s/-arm64/-custom/g" config/arm64.cfg
$ sed -i "s/EFI_SIGNED=y/#EFI_SIGNED=y/g" config/arm64.cfg
```

* Build debian-installer.  The build result will be found in `dest` folder.

```
$ make LINUX_KERNEL_ABI=5.11.0 build_cdrom_grub
$ make LINUX_KERNEL_ABI=5.11.0 build_cdrom_gtk
```


## Build CD Image

[Simple-CDD](https://wiki.debian.org/Simple-CDD) is used to build Debian
CD image here.

* Install simple-cdd and apply patches.

```
$ sudo apt install simple-cdd
$ cd /usr/share/simple-cdd
$ sudo patch -p1 < ~/debian-cdimage/patches/simple-cdd/0002-Update-default.preseed-for-aarch64-laptops-build.patch
```

* Copy installer.

```
$ cd ~/debian-cdimage/simple-cdd/
$ mkdir -p debian/installer/arm64/images/
$ cp -a ../debian-installer/installer/build/dest/* debian/installer/arm64/images/
```

* Concatenate initrd for ACPI table override.  The ACPI table of Lenovo
  Flex 5G has some problem that we need to work around by overriding the
  table.

```
$ ./misc/lenovo-flex-5g/initrd_concatenate.sh
```

* Pack Shell.efi into efi.img.

```
$ ./misc/pack_shell_efi.sh
```

* Copy udebs to localpackages.

```
$ cp ../kernel-wedge/*.udeb localpackages/
```

* Update profiles/gnome.conf.

```
$ echo "local_packages=\"$PWD/localpackages\"" >> profiles/gnome.conf
$ echo "custom_installer=\"$PWD/debian/installer\"" >> profiles/gnome.conf
```

* Build CD image.  If everything goes fine, the result CD image should be
  found as `images/debian-unstable-arm64-DVD-1.iso`.

```
$ build-simple-cdd --dvd --profiles gnome
```
